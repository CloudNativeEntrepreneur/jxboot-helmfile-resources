# Source: jxboot-helmfile-resources/templates/jx-meta-pipeline.yaml
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: jx-meta-pipeline
spec:
  params:
  - description: git url to clone
    name: REPO_URL
    type: string
  - default: master
    description: git revision to checkout (branch, tag, sha, refâ€¦)
    name: revision
    type: string
  - default: source
    description: subdirectory inside of /workspace to clone the git repo
    name: subdirectory
    type: string
  tasks:
  - name: meta-pipeline
    params:
    - name: REPO_URL
      value: $(params.REPO_URL)
    - name: revision
      value: $(params.revision)
    - name: subdirectory
      value: $(params.subdirectory)
    taskSpec:
      stepTemplate:
        resources:
          limits:
            cpu: 800m
            memory: 512Mi
          requests:
            cpu: 400m
            memory: 512Mi
        volumeMounts:
        - mountPath: /home/jenkins
          name: workspace-volume
        - mountPath: /etc/podinfo
          name: podinfo
          readOnly: true
        - mountPath: /root/.m2/
          name: jenkins-maven-settings
        workingDir: /workspace/source
      steps:
      - args:
        - -c
        - 'mkdir -p $HOME; git config --global --add user.name $GIT_AUTHOR_NAME; git config --global --add user.email $GIT_AUTHOR_EMAIL; git config --global credential.helper store; git clone $(inputs.params.REPO_URL) $(inputs.params.subdirectory); echo cloned url: $(inputs.params.REPO_URL) to dir: $(inputs.params.subdirectory); cd $(inputs.params.subdirectory); git checkout $(inputs.params.revision); echo checked out revision: $(inputs.params.revision) to dir: $(inputs.params.subdirectory)'
        command:
        - /bin/sh
        image: gcr.io/jenkinsxio/builder-jx:2.1.32-662
        name: git-clone
        workingDir: /workspace
      - args:
        - '[ -d /builder/home ] || mkdir -p /builder && ln -s /tekton/home /builder/home'
        command:
        - /bin/sh
        - -c
        env:
        image: gcr.io/jenkinsxio/builder-maven:2.1.142-761
        name: setup-builder-home
      - args:
        - step
        - git
        - merge
        - --verbose
        command:
        - jx
        image: gcr.io/jenkinsxio/builder-maven:2.1.142-761
        name: git-merge
      - args:
        - jx step git merge --verbose --baseBranch master --baseSHA ecf3d089046eaec92e4a00ba23ec66d75076384e
          --sha 766f956474495dd7b632e33faf3e58b314a77ddf
        command:
        - /bin/sh
        - -c
        image: gcr.io/jenkinsxio/builder-maven:2.1.142-761
        name: merge-pull-refs
      - args:
        - jx step syntax effective --output-dir . --context pr-build --env BUILD_NUMBER=1
          --env PIPELINE_KIND=pullrequest --env PULL_REFS=master:ecf3d089046eaec92e4a00ba23ec66d75076384e,1:766f956474495dd7b632e33faf3e58b314a77ddf
          --env PIPELINE_CONTEXT=pr-build --env SOURCE_URL=https://github.com/cb-kubecd/bdd-gh-1600712365.git
          --env REPO_OWNER=cb-kubecd --env REPO_NAME=bdd-gh-1600712365 --env APP_NAME=bdd-gh-1600712365
          --env BRANCH_NAME=PR-1 --env JOB_NAME=cb-kubecd/bdd-gh-1600712365/PR-1 --env
          JOB_TYPE=presubmit --env JOB_SPEC=type:presubmit --env PULL_BASE_REF=master
          --env PULL_BASE_SHA=ecf3d089046eaec92e4a00ba23ec66d75076384e --env PULL_NUMBER=1
          --env PULL_PULL_SHA=766f956474495dd7b632e33faf3e58b314a77ddf
        command:
        - /bin/sh
        - -c
        image: gcr.io/jenkinsxio/builder-maven:2.1.142-761
        name: create-effective-pipeline
      - args:
        - jx step create task --clone-dir /workspace/source --kind pullrequest --pr-number
          1 --service-account tekton-bot --source source --branch PR-1 --build-number
          1 --context pr-build
        command:
        - /bin/sh
        - -c
        image: gcr.io/jenkinsxio/builder-maven:2.1.142-761
        name: create-tekton-crds
      volumes:
      - name: jenkins-maven-settings
        secret:
          secretName: jenkins-maven-settings
